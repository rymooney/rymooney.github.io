---
title: "SQL"
format: html
author: "Ryan Mooney"
---
# The task
For today's project, I will be working with data from the [Stanford Open Policing Project](https://openpolicing.stanford.edu/) pubished by Pierson, et al. (2020). I will be investigating a few of the many tables contained within the database.

First, let's set up the connection to the traffic database and upload the needed packages for later analyses.

```{r}
con_traffic <- DBI::dbConnect(
  RMariaDB::MariaDB(),
  dbname = "traffic",
  host = Sys.getenv("TRAFFIC_HOST"),
  user = Sys.getenv("TRAFFIC_USER"),
  password = Sys.getenv("TRAFFIC_PWD")
)
```

```{r}
#| warning: FALSE
#| message: FALSE
library(tidyverse)
library(DBI)
```


There are many tables in the database, including three that I am particularly interested in. These data tables are called "ca_statewide_2023_01_26", "co_statewide_2020_04_01", and "ny_statewide_2020_04_01". These tables have all the statewide data for California, Colorado, and New York. Let's compare!

To get a sense of the kinds of variables included in each set, let's look at the start of the California table. 

```{sql}
#| connection: con_traffic

SELECT * FROM ca_statewide_2023_01_26 LIMIT 8;
```

First, I'd like to make a plot to show how vehicular stops have changed over the years in California, Colorado, and New York. 

I am going to UNION ALL three tables (co_statewide, ca_statewide, and ny_statewide), so that I can have one large data set with the needed data for the three states. This way, I can do the wrangling on the three states seperately and use the UNION ALL to combine those wrangled tables. I am focused on only vehicular stops, so I will include a WHERE type = 'vehicular' statement. I will also GROUP BY state and year(date) so that I will have seperate count information for each year in each state. Let's do it!

```{sql}
#| connection: con_traffic
#| output.var: stops_per_year

SELECT
    'Colorado' AS state,
    YEAR(date) AS year,
    COUNT(*) AS total_stops
FROM co_statewide_2020_04_01
WHERE type = 'vehicular'
GROUP BY state, YEAR(date)

UNION ALL

 SELECT
    'California' AS state,
    YEAR(date) AS year,
    COUNT(*) AS total_stops
FROM ca_statewide_2023_01_26
WHERE type = 'vehicular'
GROUP BY state, YEAR(date)

UNION ALL

SELECT
    'New York' AS state,
    YEAR(date) AS year,
    COUNT(*) AS total_stops
FROM ny_statewide_2020_04_01
WHERE type = 'vehicular'
GROUP BY state, YEAR(date)

ORDER BY year, state;
```

I will do some normalizing, as the first time I did the analysis below, I realized I should normalize the stops to the population size, since my analyis was making the stops in California appear much larger than the stops in Colorado and New York simply because it has a much larger state population. 
```{r}
stops_per_year_normalized <- stops_per_year |>
  filter(!is.na(year)) |>
  mutate(
    year = as.numeric(year),
    total_stops = as.numeric(total_stops),
    pop_avg = case_when(
      state == "California" ~ 38359674,
      state == "Colorado" ~  5279185,
      state == "New York" ~ 19636586,
    ),
    stops_per_1000 = total_stops / pop_avg * 1000
  )

head(stops_per_year_normalized)
```

Now we can visualize the data! Let's see how the states compare 

```{r}
#| message: FALSE
#| warning: FALSE

ggplot(stops_per_year_normalized,
       aes(x = year, y = stops_per_1000, color = state)) +
  geom_line() +
  geom_point() +
  labs(
    title = "Vehicular Stops per 1,000 Residents",
    x = "Year",
    y = "Stops per 1,000 Residents",
    color = "State"
  )
```

So, overall, California has more vehicular stops than Colorado and New York, and also has some more variation from year to year. Important to note, I just used the current state population and did not account for changes in the population from year to year. 

Next, now that I am more familiar with how these tables are organized and the specific variables available, I am interested in investigating California more closely to observe some more trends. I am interested how gender affects citation rates, as in how often do men get a citation when they are pulled over compared to women?


```{sql}
#| connection: con_traffic
SELECT
    subject_sex,
    COUNT(*) AS n_stops,
    SUM(citation_issued) AS n_with_citation,
    COUNT(*) - SUM(citation_issued) AS n_without_citation,
    AVG(citation_issued) AS citation_rate
FROM ca_statewide_2023_01_26
WHERE subject_sex IN ('male', 'female')
GROUP BY subject_sex
ORDER BY subject_sex;
```

From the above analysis, it is seen that males get citations when they are stopped more often than females. There are likely many variables going into this rate difference!

From the analyses today, we can see that California has higher vehicular stops over time than Colorado and New York, and that males have higher citation rates than females in California. 
```{r}
dbDisconnect(con_traffic, shutdown = TRUE)
```


Thanks for coming along for the ride today!

# References
Pierson, E., Simoiu, C., Overgoor, J. et al. A large-scale analysis of racial disparities in police stops across the United States. Nat Hum Behav 4, 736â€“745 (2020).